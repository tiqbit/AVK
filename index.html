<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avalikud koosolekud | Politsei- ja Piirivalveamet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    
    <!-- OpenLayers Map CSS & JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v9.1.0/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@v9.1.0/dist/ol.js"></script>

    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f8f9fa; color: #333; }
        .veera-blue { background-color: #004277; }
        .veera-text { color: #004277; }
        .card { background: white; border-radius: 2px; border: 1px solid #e1e1e1; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .btn-veera { background-color: #004277; color: white; padding: 8px 20px; border-radius: 3px; font-weight: bold; transition: 0.2s; text-transform: uppercase; letter-spacing: 0.5px; }
        .btn-veera:hover { background-color: #00335c; }
        
        /* Toggle Switch Stiil */
        .view-toggle { display: inline-flex; background: #eee; padding: 4px; border-radius: 4px; border: 1px solid #ccc; }
        .toggle-btn { padding: 6px 16px; font-size: 13px; font-weight: bold; border-radius: 2px; cursor: pointer; transition: 0.2s; color: #555; }
        .toggle-btn.active { background: #004277; color: white; }

        input, select { border: 1px solid #707070; padding: 10px; border-radius: 3px; font-size: 15px; }
        th { text-align: left; background-color: #f1f1f1; padding: 12px; font-size: 13px; text-transform: uppercase; color: #555; border-bottom: 2px solid #ddd; }
        td { padding: 15px 12px; border-bottom: 1px solid #eee; font-size: 14px; vertical-align: top; }
        .hidden { display: none; }
        .date-bold { font-weight: 700; }

        /* Kaardi konteiner */
        #map { width: 100%; height: 600px; border-radius: 2px; }
        .ol-popup {
            position: absolute; background-color: white; box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            padding: 15px; border-radius: 4px; border: 1px solid #cccccc; bottom: 12px; left: -50px; min-width: 280px;
        }
        .ol-popup:after, .ol-popup:before {
            top: 100%; border: solid transparent; content: " "; height: 0; width: 0; position: absolute; pointer-events: none;
        }
        .ol-popup:after { border-top-color: white; border-width: 10px; left: 48px; margin-left: -10px; }
        .ol-popup:before { border-top-color: #cccccc; border-width: 11px; left: 48px; margin-left: -11px; }
    </style>
</head>
<body>

    <header class="veera-blue text-white p-4 shadow-md">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-6 cursor-pointer" onclick="showView('home')">
                <div class="font-bold text-xl tracking-tight uppercase">Politsei- ja Piirivalveamet</div>
            </div>
            <div id="authButtons">
                <button onclick="showView('tara')" class="bg-white text-blue-900 px-4 py-1 rounded text-sm font-bold uppercase mr-2">Logi sisse korraldajana</button>
                <button onclick="showView('tara')" class="bg-blue-800 text-white px-4 py-1 rounded text-sm font-bold border border-blue-400 uppercase">Logi sisse ametnikuna</button>
            </div>
            <div id="userProfile" class="hidden flex items-center space-x-4 uppercase font-bold text-sm">
                <span class="border-r pr-4 border-blue-400">Jaan Tamm</span>
                <button onclick="logout()" class="underline font-normal">Logi välja</button>
            </div>
        </div>
    </header>

    <main id="view-home" class="max-w-7xl mx-auto py-10 px-4">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <h1 class="text-3xl font-bold veera-text">Politseis registreeritud avalikud koosolekud</h1>
            
            <!-- Vaate lüliti -->
            <div class="view-toggle">
                <div id="btn-tabel" onclick="switchSubView('tabel')" class="toggle-btn active uppercase">Tabelina</div>
                <div id="btn-kaart" onclick="switchSubView('kaart')" class="toggle-btn uppercase">Kaardil</div>
            </div>
        </div>
        
        <!-- Otsingu sektsioon -->
        <div class="card p-6 mb-8 bg-gray-50 border-t-4 border-t-blue-800">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
                <div>
                    <label class="block text-sm font-bold mb-1 uppercase text-gray-600">Alates</label>
                    <input type="text" id="filter-alates" class="w-full" placeholder="pp.kk.aaaa">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1 uppercase text-gray-600">Kuni</label>
                    <input type="text" class="w-full" placeholder="pp.kk.aaaa">
                </div>
                <div>
                    <label class="block text-sm font-bold mb-1 uppercase text-gray-600">Märksõna / Koht</label>
                    <input type="text" class="w-full" placeholder="Tallinn, Vabaduse väljak...">
                </div>
                <button class="btn-veera w-full h-[46px]">Otsi</button>
            </div>
        </div>

        <!-- TABELI VAADE -->
        <div id="subview-tabel" class="card overflow-x-auto">
            <table class="w-full border-collapse">
                <thead>
                    <tr>
                        <th width="200">Aeg</th>
                        <th width="35%">Koht / Marsruut</th>
                        <th>Eesmärk / Korraldaja</th>
                    </tr>
                </thead>
                <tbody id="meeting-table-body">
                    <!-- Sisu genereeritakse JS-is -->
                </tbody>
            </table>
        </div>

        <!-- KAARDI VAADE -->
        <div id="subview-kaart" class="hidden">
            <div class="card p-2 relative">
                <div id="map"></div>
                <div id="popup" class="ol-popup">
                    <a href="#" id="popup-closer" class="absolute top-2 right-2 text-gray-400">✖</a>
                    <div id="popup-content"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- MUUD VAATED (TARA, VORM jne jäävad samaks) -->
    <main id="view-tara" class="hidden max-w-2xl mx-auto py-20 px-4">
        <div class="card p-10 text-center border-t-4 border-t-blue-800">
            <img src="https://e-gov.github.io/TARA-Doku/img/tara-logo.png" alt="TARA" class="h-12 mx-auto mb-8">
            <h2 class="text-xl font-bold mb-6 uppercase">Valige autentimisvahend</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div onclick="loginSuccess()" class="tara-method font-bold text-blue-700">ID-kaart</div>
                <div onclick="loginSuccess()" class="tara-method font-bold text-blue-700">Mobiil-ID</div>
                <div onclick="loginSuccess()" class="tara-method font-bold text-blue-700">Smart-ID</div>
            </div>
            <button onclick="showView('home')" class="text-sm underline font-bold uppercase text-gray-500">Tühista</button>
        </div>
    </main>

    <main id="view-form" class="hidden max-w-4xl mx-auto py-10 px-4">
        <div class="card p-8 border-t-4 border-t-blue-800">
            <h2 class="text-2xl font-bold mb-6 veera-text border-b pb-4">Avaliku koosoleku teatamine</h2>
            <div class="bg-blue-50 p-4 mb-6 border-l-4 border-blue-800">Olete sisse logitud kui <strong>JAAN TAMM (38001010000)</strong></div>
            <button onclick="showView('success')" class="btn-veera">Esita teade politseile</button>
        </div>
    </main>

    <main id="view-success" class="hidden max-w-2xl mx-auto py-20 px-4 text-center">
        <div class="card p-12 border-t-4 border-t-green-600">
            <h2 class="text-2xl font-bold mb-4 uppercase">Teade edukalt esitatud!</h2>
            <button onclick="showView('home')" class="btn-veera">Tagasi avalehele</button>
        </div>
    </main>

    <script>
        // NÄIDISANDMED (asukohtadega kaardi jaoks)
        const meetings = [
            {
                id: 1,
                dateStr: "<span class='date-bold'>24.05.2024</span> 12:00 - 16:00",
                place: "Tallinn, Vabaduse väljak",
                route: "Vabaduse väljak – Kaarli pst – Toompea – Lossi plats – Pikk jalg – Raekoja plats",
                title: "Traditsiooniline vanalinna ringkäik",
                org: "MTÜ Tallinna Kultuuripärand",
                coords: [24.744, 59.433] // Tallinn
            },
            {
                id: 2,
                dateStr: "<span class='date-bold'>26.05.2024</span> 09:00 - <br><span class='date-bold'>28.05.2024</span> 21:00",
                place: "Tartu, Raekoja plats",
                route: "",
                title: "Kevadine tudengifestival",
                org: "Tartu Üliõpilaskond",
                coords: [26.722, 58.380] // Tartu
            },
            {
                id: 3,
                dateStr: "<span class='date-bold'>30.05.2024</span> 17:30 - 19:00",
                place: "Pärnu, Iseseisvuse väljak",
                route: "",
                title: "Pikett raamatukogu toetuseks",
                org: "Eraisik Mari Mets",
                coords: [24.500, 58.385] // Pärnu
            }
        ];

        let map; // OpenLayers kaardi objekt

        function initMap() {
            if (map) return; // Kui kaart on juba loodud, ära tee uuesti

            const container = document.getElementById('popup');
            const content = document.getElementById('popup-content');
            const closer = document.getElementById('popup-closer');

            const overlay = new ol.Overlay({
                element: container,
                autoPan: true,
                autoPanAnimation: { duration: 250 }
            });

            closer.onclick = function() {
                overlay.setPosition(undefined);
                closer.blur();
                return false;
            };

            map = new ol.Map({
                target: 'map',
                layers: [
                    new ol.layer.Tile({ source: new ol.source.OSM() })
                ],
                overlays: [overlay],
                view: new ol.View({
                    center: ol.proj.fromLonLat([25.5, 58.8]), // Eesti keskpunkt
                    zoom: 7.5
                })
            });

            // Lisa markerid
            const features = meetings.map(m => {
                const f = new ol.Feature({
                    geometry: new ol.geom.Point(ol.proj.fromLonLat(m.coords)),
                    name: m.title,
                    desc: m.dateStr + "<br><b>" + m.place + "</b><br>" + m.org
                });
                return f;
            });

            const vectorSource = new ol.source.Vector({ features });
            const vectorLayer = new ol.layer.Vector({
                source: vectorSource,
                style: new ol.style.Style({
                    image: new ol.style.Circle({
                        radius: 8,
                        fill: new ol.style.Fill({color: '#004277'}),
                        stroke: new ol.style.Stroke({color: 'white', width: 2})
                    })
                })
            });
            map.addLayer(vectorLayer);

            // Kliki sündmus kaardil
            map.on('singleclick', function (evt) {
                const feature = map.forEachFeatureAtPixel(evt.pixel, f => f);
                if (feature) {
                    const coordinate = evt.coordinate;
                    content.innerHTML = '<div class="text-sm">' + feature.get('desc') + '</div>';
                    overlay.setPosition(coordinate);
                } else {
                    overlay.setPosition(undefined);
                }
            });
        }

        function switchSubView(view) {
            const tabel = document.getElementById('subview-tabel');
            const kaart = document.getElementById('subview-kaart');
            const btnTabel = document.getElementById('btn-tabel');
            const btnKaart = document.getElementById('btn-kaart');

            if (view === 'kaart') {
                tabel.classList.add('hidden');
                kaart.classList.remove('hidden');
                btnKaart.classList.add('active');
                btnTabel.classList.remove('active');
                setTimeout(initMap, 100); // Väike viide, et kaart jõuaks renderdada
            } else {
                tabel.classList.remove('hidden');
                kaart.classList.add('hidden');
                btnTabel.classList.add('active');
                btnKaart.classList.remove('active');
            }
        }

        function showView(viewName) {
            document.querySelectorAll('main').forEach(v => v.classList.add('hidden'));
            document.getElementById('view-' + viewName).classList.remove('hidden');
            if (viewName === 'home') switchSubView('tabel');
        }

        function populateTable() {
            const body = document.getElementById('meeting-table-body');
            body.innerHTML = meetings.map(m => `
                <tr>
                    <td>${m.dateStr}</td>
                    <td>
                        <strong>Koht:</strong> ${m.place}
                        ${m.route ? `<div class="text-gray-600 text-sm italic mt-1"><strong>Marsruut:</strong> ${m.route}</div>` : ''}
                    </td>
                    <td>
                        <div class="veera-text font-bold uppercase mb-1">${m.title}</div>
                        <div class="text-gray-700 font-bold">${m.org}</div>
                    </td>
                </tr>
            `).join('');
        }

        // Tänane kuupäev Alates väljale
        function setDefaultDate() {
            const d = new Date();
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            document.getElementById('filter-alates').value = `${day}.${month}.${year}`;
        }

        function loginSuccess() {
            document.getElementById('authButtons').classList.add('hidden');
            document.getElementById('userProfile').classList.remove('hidden');
            showView('form');
        }

        function logout() {
            document.getElementById('authButtons').classList.remove('hidden');
            document.getElementById('userProfile').classList.add('hidden');
            showView('home');
        }

        window.onload = () => {
            populateTable();
            setDefaultDate();
        };
    </script>
</body>
</html>
